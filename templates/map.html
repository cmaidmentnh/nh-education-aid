{% extends "base.html" %}
{% block title %}Funding Map - NH Education Funding Facts{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 750px;
        width: 100%;
        border-radius: 0.75rem;
        background: #ffffff;
    }
    .info-panel {
        padding: 12px 16px;
        background: white;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        border-radius: 10px;
        font-family: 'Inter', sans-serif;
        line-height: 1.6;
        min-width: 180px;
    }
    .info-panel h4 {
        margin: 0 0 6px;
        font-size: 16px;
        font-weight: 700;
        color: #0f172a;
    }
    .info-panel .stat {
        font-size: 13px;
        color: #64748b;
    }
    .info-panel .stat strong {
        color: #0f172a;
        font-weight: 600;
    }
    .legend {
        padding: 10px 14px;
        background: white;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        border-radius: 10px;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        line-height: 2;
    }
    .legend-title {
        font-weight: 700;
        font-size: 13px;
        margin-bottom: 4px;
        color: #0f172a;
    }
    .legend i {
        width: 20px;
        height: 14px;
        display: inline-block;
        margin-right: 8px;
        border-radius: 3px;
        vertical-align: middle;
        border: 1px solid rgba(0,0,0,0.1);
    }
    .leaflet-container {
        background: #ffffff !important;
    }
    @media (max-width: 768px) {
        #map { height: 500px; }
    }
</style>
{% endblock %}

{% block content %}
<section class="hero-gradient text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-extrabold mb-2">Education Funding Map</h1>
        <p class="text-gray-300 mb-4">Explore education funding across every NH municipality. Hover for details, click to view full history.</p>
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label for="year-select" class="text-sm text-gray-300">Fiscal Year:</label>
                <select id="year-select" class="bg-navy-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-growth">
                    {% for y in years|reverse %}
                    <option value="{{ y }}" {% if loop.first %}selected{% endif %}>FY{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label for="metric-select" class="text-sm text-gray-300">Color by:</label>
                <select id="metric-select" class="bg-navy-700 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-growth">
                    <option value="per_pupil" selected>Aid Per Pupil</option>
                    <option value="grant">Total Adequacy Grant</option>
                    <option value="state_grant">Total State Grant</option>
                </select>
            </div>
        </div>
    </div>
</section>

<section class="py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="map"></div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('map', {
        center: [43.8, -71.5],
        zoom: 8,
        zoomControl: true,
        scrollWheelZoom: true,
        attributionControl: false,
    });

    // No tile layer - clean white background, just the shapes

    let geojsonLayer = null;
    let geojsonData = null;
    let townData = {};
    let cachedMinMax = { min: 0, max: 1 };

    const nameMap = {
        "Atkinson & Gilmanton": "Atk. & Gilmanton Acad.",
        "Hart's Location": "Harts Location",
        "Low & Burbanks": "Low And Burbanks Grant",
        "Pinkham's Grant": "Pinkhams Grant",
        "Second College": "Second College Grant",
        "Thompson & Meserve": "Thompson And Meserves Purchase",
    };

    // 7-step sequential green: white -> bright green -> deep green
    const colorScale = [
        '#f7fee7',
        '#d9f99d',
        '#a3e635',
        '#4ade80',
        '#22c55e',
        '#15803d',
        '#14532d',
    ];
    const NO_DATA_COLOR = '#f1f5f9';

    function getColor(value) {
        if (value === null || value === undefined) return NO_DATA_COLOR;
        const { min, max } = cachedMinMax;
        if (max === min) return colorScale[3];
        const ratio = Math.max(0, Math.min(1, (value - min) / (max - min)));
        const idx = Math.min(Math.floor(ratio * colorScale.length), colorScale.length - 1);
        return colorScale[idx];
    }

    function formatCurrency(val) {
        if (val === null || val === undefined) return 'N/A';
        if (Math.abs(val) >= 1000000) return '$' + (val / 1000000).toFixed(1) + 'M';
        return '$' + Math.round(val).toLocaleString();
    }

    // Info panel
    const info = L.control({ position: 'topright' });
    info.onAdd = function() {
        this._div = L.DomUtil.create('div', 'info-panel');
        this.update();
        return this._div;
    };
    info.update = function(name, data) {
        if (!name) {
            this._div.innerHTML = '<h4>Hover over a town</h4>';
            return;
        }
        let html = '<h4>' + name + '</h4>';
        if (data) {
            if (data.per_pupil != null)
                html += '<div class="stat">Aid Per Pupil: <strong>' + formatCurrency(data.per_pupil) + '</strong></div>';
            if (data.grant != null)
                html += '<div class="stat">Adequacy Grant: <strong>' + formatCurrency(data.grant) + '</strong></div>';
            if (data.adm != null)
                html += '<div class="stat">Students: <strong>' + Math.round(data.adm).toLocaleString() + '</strong></div>';
        } else {
            html += '<div class="stat" style="color:#94a3b8;">No data for this year</div>';
        }
        this._div.innerHTML = html;
    };
    info.addTo(map);

    // Legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
        this._div = L.DomUtil.create('div', 'legend');
        return this._div;
    };
    legend.update = function(min, max, metric) {
        const labels = {
            per_pupil: 'Aid Per Pupil',
            grant: 'Adequacy Grant',
            state_grant: 'Total State Grant'
        };
        let html = '<div class="legend-title">' + labels[metric] + '</div>';
        for (let i = 0; i < colorScale.length; i++) {
            const val = min + (max - min) * (i / (colorScale.length - 1));
            html += '<i style="background:' + colorScale[i] + '"></i>' + formatCurrency(val) + '<br>';
        }
        html += '<i style="background:' + NO_DATA_COLOR + '"></i>No data';
        this._div.innerHTML = html;
    };
    legend.addTo(map);

    function getMetric() {
        return document.getElementById('metric-select').value;
    }

    function computeMinMax() {
        const metric = getMetric();
        const vals = Object.values(townData)
            .map(d => d[metric])
            .filter(v => v != null && v > 0);
        cachedMinMax = {
            min: vals.length ? Math.min(...vals) : 0,
            max: vals.length ? Math.max(...vals) : 1,
        };
    }

    function styleFeature(feature) {
        const name = feature.properties.name;
        const data = townData[name];
        const metric = getMetric();
        const value = data ? data[metric] : null;

        return {
            fillColor: getColor(value),
            weight: 1,
            opacity: 1,
            color: '#94a3b8',
            fillOpacity: 0.9,
        };
    }

    function highlightFeature(e) {
        e.target.setStyle({
            weight: 2.5,
            color: '#0f172a',
            fillOpacity: 1,
        });
        e.target.bringToFront();
        const name = e.target.feature.properties.name;
        info.update(name, townData[name]);
    }

    function resetHighlight(e) {
        geojsonLayer.resetStyle(e.target);
        info.update();
    }

    function clickFeature(e) {
        const geoName = e.target.feature.properties.name;
        const dbName = nameMap[geoName] || geoName;
        window.location.href = '/town/' + encodeURIComponent(dbName);
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: clickFeature,
        });
    }

    function updateMap() {
        const year = document.getElementById('year-select').value;

        fetch('/api/map-data?year=' + year)
            .then(r => r.json())
            .then(data => {
                townData = data;
                computeMinMax();

                if (geojsonLayer) {
                    geojsonLayer.setStyle(styleFeature);
                } else if (geojsonData) {
                    geojsonLayer = L.geoJSON(geojsonData, {
                        style: styleFeature,
                        onEachFeature: onEachFeature,
                    }).addTo(map);
                    map.fitBounds(geojsonLayer.getBounds(), { padding: [20, 20] });
                }

                legend.update(cachedMinMax.min, cachedMinMax.max, getMetric());
            });
    }

    fetch('/static/data/nh_towns.geojson')
        .then(r => r.json())
        .then(data => {
            geojsonData = data;
            updateMap();
        });

    document.getElementById('year-select').addEventListener('change', updateMap);
    document.getElementById('metric-select').addEventListener('change', updateMap);
});
</script>
{% endblock %}
